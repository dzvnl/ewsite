<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'VT323', monospace;
            color: #e5e5e5;
            background-color: #000000; 
            /* Fallback */
            background-image: url('IMG_4928.jpeg'); 
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }
        .pixel-font {
            font-family: 'VT323', monospace;
            font-smooth: never;
            -webkit-font-smoothing: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* --- SCROLLBARS --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #555; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* --- CHAT WIDGET CSS --- */
        #chat-widget {
            position: fixed;
            top: 20%;
            left: 20%;
            width: 350px;
            height: 400px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #555;
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            resize: both; /* Allows resizing */
            overflow: hidden; /* Required for resize */
            min-width: 250px;
            min-height: 200px;
        }
        /* State: Minimized */
        #chat-widget.minimized {
            height: 32px !important;
            resize: none;
            overflow: hidden;
        }
        /* State: Maximized */
        #chat-widget.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            resize: none;
        }
        /* State: Closed */
        #chat-widget.closed { display: none; }

        #chat-header {
            background-color: #333;
            color: #facc15;
            padding: 4px 8px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
            flex-shrink: 0;
            user-select: none;
        }
        #chat-header:active { cursor: grabbing; }

        .chat-controls button {
            background: none;
            border: none;
            color: #ccc;
            margin-left: 5px;
            cursor: pointer;
            font-family: 'VT323';
            font-size: 1.2rem;
        }
        .chat-controls button:hover { color: #fff; }

        #chat-messages {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 1.1rem;
            word-wrap: break-word;
        }

        .message-row { margin-bottom: 6px; line-height: 1.2; }
        .msg-time { color: #666; font-size: 0.8rem; margin-right: 4px; }
        .msg-user { color: #aaa; font-weight: bold; }
        .msg-user.admin { color: #ef4444; text-shadow: 0 0 2px red; } /* Red for admins */
        .msg-text { color: #ddd; }
        .msg-announcement { 
            color: #facc15; 
            border: 1px dashed #facc15; 
            padding: 4px; 
            margin: 5px 0; 
            text-align: center;
            background: rgba(250, 204, 21, 0.1);
        }
        .delete-btn {
            color: red;
            cursor: pointer;
            margin-left: 5px;
            font-size: 0.8rem;
            display: none; /* Hidden by default */
        }
        .delete-btn:hover { background: #333; }

        #chat-input-area {
            display: flex;
            border-top: 1px solid #555;
            padding: 5px;
            background: #111;
            flex-shrink: 0;
        }
        #chat-input {
            flex-grow: 1;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 4px;
            font-family: 'VT323';
            font-size: 1.1rem;
            outline: none;
        }
        #chat-send {
            background: #333;
            color: #facc15;
            border: 1px solid #555;
            margin-left: 5px;
            padding: 0 10px;
            cursor: pointer;
            font-family: 'VT323';
        }

        /* --- ADMIN PANEL MODAL --- */
        #admin-panel {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #ef4444;
            padding: 20px;
            z-index: 200;
            width: 300px;
            display: none; /* Hidden */
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }
        #admin-panel h2 { color: #ef4444; font-size: 1.5rem; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .admin-btn {
            display: block;
            width: 100%;
            background: #222;
            color: #fff;
            border: 1px solid #555;
            padding: 5px;
            margin-top: 10px;
            cursor: pointer;
            font-family: 'VT323';
            font-size: 1.2rem;
        }
        .admin-btn:hover { background: #ef4444; color: #000; }
        .close-modal { position: absolute; top: 5px; right: 10px; color: #666; cursor: pointer; }

        /* --- MUSIC PLAYER (From previous code) --- */
        #music-player-widget {
            position: fixed;
            bottom: 1.5rem; 
            right: 1.5rem;
            z-index: 50;
            width: 320px; 
            background-color: rgba(0, 0, 0, 0.85);
            border: 1px solid #333;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            border-radius: 4px;
            backdrop-filter: blur(2px);
        }
        #player-cover-art { width: 64px; height: 64px; flex-shrink: 0; margin-right: 0.75rem; border: 2px dotted #555; background-color: #111; image-rendering: pixelated; }
        #player-main { flex-grow: 1; overflow: hidden; min-width: 0; }
        #player-title { color: #ffffff; font-size: 1.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-artist { font-size: 1rem; color: #969696; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .player-controls-row { display: flex; align-items: center; gap: 0.5rem; }
        .player-controls-row button { color: #facc15; font-size: 1.25rem; background: none; border: none; cursor: pointer; padding: 0; font-family: 'VT323'; }
        #volume-slider { -webkit-appearance: none; width: 100%; flex-grow: 1; height: 4px; background: #333; margin-left: 0.5rem; cursor: pointer; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #facc15; border: 1px solid #000; margin-top: -4px; }
    </style>
</head>
<body>

    <div class="fixed top-6 right-8 text-right z-50 pixel-font">
        <div id="welcome-message" class="text-2xl text-gray-200 cursor-pointer hover:text-white select-none">Welcome, ?</div>
        <a href="#" id="auth-link" class="block text-xl text-yellow-500 hover:text-white transition-colors cursor-pointer mt-1 underline decoration-dotted">
            (sign up / sign in)
        </a>
    </div>

    <div class="fixed inset-0 flex items-center justify-center pointer-events-none z-0">
        <h1 id="splash-text" class="text-4xl md:text-6xl text-center text-gray-200 pixel-font drop-shadow-md px-4">
            welcome.
        </h1>
    </div>

    <nav class="fixed left-0 top-1/2 -translate-y-1/2 p-6 sm:p-8 pixel-font z-10">
        <ul class="text-3xl lg:text-4xl space-y-2" style="color: #969696;">
            <li><a href="/secrets" class="hover:text-red-600 hover:pl-2 transition-all duration-200 block">home</a></li>
            <li><a href="/list" class="hover:text-red-600 hover:pl-2 transition-all duration-200 block">list</a></li>
            <li><a href="#" id="toggle-chat-btn" class="hover:text-red-600 hover:pl-2 transition-all duration-200 block">chat</a></li>
            <li><a href="https://yodelling-amberly-ewsite-0c6ae866.koyeb.app/" class="hover:text-red-600 hover:pl-2 transition-all duration-200 block">proxy</a></li>
        </ul>
    </nav>

    <div id="music-player-widget">
        <img id="player-cover-art" src="https://placehold.co/64x64/000000/333333?text=Art&font=vt323" alt="Cover">
        <div id="player-main">
            <div id="player-title">Select Song</div>
            <div id="player-artist">...</div>
            <div class="player-controls-row">
                <button id="rewind-btn">[<<]</button>
                <button id="play-pause-btn">[>]</button>
                <button id="skip-btn">[>>]</button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5">
            </div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <div id="chat-widget">
        <div id="chat-header">
            <span>// CHAT_ROOM_01</span>
            <div class="chat-controls">
                <button id="chat-min-btn">_</button>
                <button id="chat-max-btn">[]</button>
                <button id="chat-close-btn">X</button>
            </div>
        </div>
        <div id="chat-messages">
            <div class="message-row"><span class="msg-text" style="color:#666">Connecting to database...</span></div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Say something..." autocomplete="off">
            <button id="chat-send">SEND</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="close-modal" onclick="document.getElementById('admin-panel').style.display='none'">[x]</div>
        <h2>// ADMIN CONSOLE</h2>
        <input type="text" id="admin-announce-input" placeholder="Announcement text..." style="width:100%; background:#111; color:#fff; border:1px solid #555; padding:4px; font-family:'VT323'; margin-bottom:5px;">
        <button class="admin-btn" id="btn-create-announcement">POST ANNOUNCEMENT</button>
        <div style="height:10px;"></div>
        <input type="text" id="admin-mute-user" placeholder="Username to mute..." style="width:100%; background:#111; color:#fff; border:1px solid #555; padding:4px; font-family:'VT323'; margin-bottom:5px;">
        <button class="admin-btn" id="btn-mute-user">MUTE USER</button>
        <button class="admin-btn" id="btn-clear-chat" style="color:red; border-color:red; margin-top:20px;">CLEAR ALL CHAT</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, set, get, child } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAlUyqTb9onQ0PyOxLfZkDddeSnYdB2PlQ",
            authDomain: "ewsitechat.firebaseapp.com",
            databaseURL: "https://ewsitechat-default-rtdb.firebaseio.com",
            projectId: "ewsitechat",
            storageBucket: "ewsitechat.firebasestorage.app",
            messagingSenderId: "282495574514",
            appId: "1:282495574514:web:e2781da630d93fc1ce8b6b",
            measurementId: "G-GTN3TL1P2K"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');
        const mutedRef = ref(db, 'muted');

        // --- ADMIN CONFIG ---
        const admins = ['-nl', 'fb67', 'root'];
        let currentUser = localStorage.getItem('username') || null;

        // --- DOM ELEMENTS ---
        const chatWidget = document.getElementById('chat-widget');
        const chatHeader = document.getElementById('chat-header');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const welcomeMsg = document.getElementById('welcome-message');

        // --- DRAG FUNCTIONALITY ---
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        chatHeader.addEventListener('mousedown', (e) => {
            if(e.target.closest('button')) return; // Don't drag if clicking buttons
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            const rect = chatWidget.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            chatWidget.style.left = `${initialLeft + dx}px`;
            chatWidget.style.top = `${initialTop + dy}px`;
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        // --- WIDGET CONTROLS ---
        document.getElementById('chat-min-btn').addEventListener('click', () => {
            chatWidget.classList.toggle('minimized');
            chatWidget.classList.remove('maximized');
        });

        document.getElementById('chat-max-btn').addEventListener('click', () => {
            chatWidget.classList.toggle('maximized');
            chatWidget.classList.remove('minimized');
        });

        document.getElementById('chat-close-btn').addEventListener('click', () => {
            chatWidget.classList.add('closed');
        });

        toggleChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            chatWidget.classList.remove('closed');
        });

        // --- ADMIN PANEL LOGIC ---
        // Open admin panel if admin clicks their username
        welcomeMsg.addEventListener('click', () => {
            if (admins.includes(currentUser)) {
                document.getElementById('admin-panel').style.display = 'block';
            }
        });

        // Create Announcement
        document.getElementById('btn-create-announcement').addEventListener('click', () => {
            const text = document.getElementById('admin-announce-input').value;
            if(!text) return;
            push(messagesRef, {
                username: currentUser,
                text: text,
                type: 'announcement',
                timestamp: Date.now()
            });
            document.getElementById('admin-announce-input').value = '';
            document.getElementById('admin-panel').style.display = 'none';
        });

        // Mute User
        document.getElementById('btn-mute-user').addEventListener('click', async () => {
            const userToMute = document.getElementById('admin-mute-user').value.trim();
            if(userToMute) {
                // We use a simple object structure for muted users: muted/username = true
                await set(ref(db, 'muted/' + userToMute), true);
                alert(`User ${userToMute} muted.`);
            }
        });
        
        // Clear Chat
        document.getElementById('btn-clear-chat').addEventListener('click', () => {
             if(confirm("DELETE ALL MESSAGES?")) {
                 remove(messagesRef);
             }
        });

        // --- CHAT LOGIC ---
        
        // Check if user is muted before sending
        async function isMuted(username) {
            const snapshot = await get(child(mutedRef, username));
            return snapshot.exists();
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !currentUser) {
                if(!currentUser) alert("Please sign in first (top right).");
                return;
            }

            if(await isMuted(currentUser)) {
                alert("You are muted.");
                return;
            }

            push(messagesRef, {
                username: currentUser,
                text: text,
                type: 'message',
                timestamp: Date.now()
            });
            chatInput.value = '';
        }

        chatSendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        // Listen for messages
        onChildAdded(messagesRef, (snapshot) => {
            const data = snapshot.val();
            const msgKey = snapshot.key;
            const isAnnouncement = data.type === 'announcement';
            const isAdminMsg = admins.includes(data.username);

            const div = document.createElement('div');
            div.className = 'message-row';
            div.id = `msg-${msgKey}`;

            // Delete button for admins
            let deleteBtnHtml = '';
            if (admins.includes(currentUser)) {
                deleteBtnHtml = `<span class="delete-btn" data-key="${msgKey}">[x]</span>`;
            }

            if (isAnnouncement) {
                div.innerHTML = `<div class="msg-announcement">★ ${data.text} ★${deleteBtnHtml}</div>`;
            } else {
                const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                div.innerHTML = `
                    <span class="msg-time">[${time}]</span>
                    <span class="msg-user ${isAdminMsg ? 'admin' : ''}">${data.username}:</span>
                    <span class="msg-text">${data.text}</span>
                    ${deleteBtnHtml}
                `;
            }

            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Attach delete event
            if (admins.includes(currentUser)) {
                const btn = div.querySelector('.delete-btn');
                if(btn) {
                    btn.style.display = 'inline';
                    btn.addEventListener('click', () => {
                        remove(ref(db, `messages/${msgKey}`));
                        div.remove();
                    });
                }
            }
        });
        
        // Handle removals in realtime (if another admin deletes)
        // Note: onChildAdded handles adds, we need logic if a node is removed remotely
        // Ideally we use onChildRemoved, but for simplicity, we just handled the local delete click above.
        // For full sync:
        import { onChildRemoved } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        onChildRemoved(messagesRef, (snapshot) => {
            const el = document.getElementById(`msg-${snapshot.key}`);
            if(el) el.remove();
        });

        // --- GLOBAL UI UPDATES (from previous code) ---
        window.updateAuthUI = function() {
            currentUser = localStorage.getItem('username');
            const welcomeMessage = document.getElementById('welcome-message');
            const authLink = document.getElementById('auth-link');
            
            if (currentUser) {
                welcomeMessage.textContent = `Welcome, ${currentUser}`;
                authLink.textContent = '(sign out)';
                authLink.onclick = (e) => {
                    e.preventDefault();
                    localStorage.removeItem('username');
                    window.updateAuthUI();
                };
            } else {
                welcomeMessage.textContent = 'Welcome, ?';
                authLink.textContent = '(sign up / sign in)';
                authLink.onclick = (e) => {
                    e.preventDefault();
                    const name = prompt('Enter your name:');
                    if (name && name.trim() !== '') {
                        localStorage.setItem('username', name.trim());
                        window.updateAuthUI();
                    }
                };
            }
        };
        window.updateAuthUI(); // Init
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Splash Logic
                const splashElement = document.getElementById('splash-text');
                if (splashElement) {
                    const splashOptions = [
                        "considering a page", "long live futtbucker", "six seven", "oh brother..",
                        "are you even an ew student?", "i bet ur failing", "get the bawlls!!",
                        "six one", "add jiggletip on clash", "new stuff soon",
                        "WE yes WE are brainless and failing", "updates soon.. -nl", "no super seniors", "merry christmas"
                    ];
                    splashElement.textContent = splashOptions[Math.floor(Math.random() * splashOptions.length)];
                }

                // Music Player Logic
                const playlist = [
                    { title: "Song One", artist: "Unknown", src: "song1.mp3", cover: "cover1.jpg" },
                    { title: "Song Two", artist: "Unknown", src: "song2.mp3", cover: "cover2.jpg" }
                ];
                const secretSong = { title: "hey, big guy", artist: "secret", src: "clock.mp3", cover: "handofpeace.jpg" };
                
                const audioPlayer = document.getElementById('audio-player');
                const playPauseBtn = document.getElementById('play-pause-btn');
                const rewindBtn = document.getElementById('rewind-btn');
                const skipBtn = document.getElementById('skip-btn');
                const playerTitleEl = document.getElementById('player-title');
                const playerArtistEl = document.getElementById('player-artist');
                const volumeSlider = document.getElementById('volume-slider');
                const playerCoverArt = document.getElementById('player-cover-art');
                let currentSongIndex = 0;
                let isPlaying = false;

                function loadSong(index) {
                    if(!playlist.length) return;
                    const song = index === -1 ? secretSong : playlist[index];
                    audioPlayer.src = song.src;
                    playerTitleEl.textContent = song.title;
                    playerArtistEl.textContent = song.artist;
                    playerCoverArt.src = song.cover || "";
                }

                function playSong() { audioPlayer.play().then(() => { isPlaying = true; playPauseBtn.textContent = '[||]'; }).catch(e => console.log(e)); }
                function pauseSong() { audioPlayer.pause(); isPlaying = false; playPauseBtn.textContent = '[>]'; }
                
                playPauseBtn.addEventListener('click', () => isPlaying ? pauseSong() : playSong());
                skipBtn.addEventListener('click', () => {
                    currentSongIndex = (currentSongIndex + 1) % playlist.length;
                    loadSong(currentSongIndex);
                    playSong();
                });
                rewindBtn.addEventListener('click', () => {
                    currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
                    loadSong(currentSongIndex);
                    playSong();
                });
                volumeSlider.addEventListener('input', (e) => audioPlayer.volume = e.target.value);
                
                // Init load
                if(playlist.length > 0) loadSong(0);

            } catch (e) { console.error(e); }
        });
    </script>
</body>
</html>
