<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <script src="playlist.js"></script>
    
    <style>
        html, body { height: 100%; scroll-behavior: smooth; }
        body {
            font-family: 'VT323', monospace;
            color: #e5e5e5;
            background-color: #000000; 
            /* This is now a fallback, JS will override it */
            background-image: url('IMG_4928.jpeg'); 
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }
        .pixel-font {
            font-family: 'VT323', monospace;
            font-smooth: never;
            -webkit-font-smoothing: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        
        /* --- STANDARDIZED PLAYER CSS --- */
        #music-player-widget {
            position: fixed;
            bottom: 1.5rem; /* Standardized to bottom-right */
            right: 1.5rem;
            z-index: 50;
            width: 320px; 
            height: auto;
            background-color: rgba(0, 0, 0, 0.8);
            border: none;
            padding: 0.75rem;
            display: flex;
            align-items: center;
        }
        #player-cover-art {
            width: 64px;
            height: 64px;
            flex-shrink: 0; 
            margin-right: 0.75rem; 
            border: 2px dotted #969696; 
            background-color: #111;
            image-rendering: pixelated;
        }
        #player-main { flex-grow: 1; overflow: hidden; min-width: 0; }
        #player-title {
            color: #ffffff;
            font-size: 1.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #player-artist {
            font-size: 0.875rem;
            color: #969696;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .player-controls-row { display: flex; align-items: center; gap: 0.25rem; }
        .player-controls-row button {
            color: #facc15;
            font-size: 1.25rem;
            flex-shrink: 0;
            padding: 0 0.25rem;
        }
        #play-pause-btn { font-size: 1.5rem; line-height: 1; }
        #volume-slider {
            -webkit-appearance: none;
            width: 100%; 
            flex-grow: 1;
            height: 16px; 
            background: transparent;
            margin-left: 0.5rem; 
        }
        #volume-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #333;
            border: 1px solid #969696;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #facc15; 
            border: 1px solid #000;
            border-radius: 50%;
            margin-top: -7px; 
        }
    </style>
</head>
<body>

    <nav class="fixed left-0 top-1/2 -translate-y-1/2 p-6 sm:p-8 pixel-font z-10">
        <h1 class="text-3xl lg:text-4xl text-gray-300 mb-2" style="color: #bebebe;"></h1>
        <ul class="text-2xl lg:text-3xl space-y-1" style="color: #969696;">
            <li><a href="/secrets" class="hover:text-red-900">home</a></li>
            <li><a href="/list" class="hover:text-red-900">list</a></li>
            <li><a href="/updates" class="hover:text-red-900">updates</a></li>
            <li><a href="/contact" class="hover:text-red-900">contact</a></li>
            </ul>
    </nav>

    <div class="fixed top-2/3 left-1/2 -translate-x-1/2 -translate-y-1/2 pixel-font text-yellow-400 text-lg lg:text-xl text-center z-10 p-4">
        <p id="splash-text"></p>
    </div>

    <div class="fixed top-0 right-0 p-4 pixel-font text-yellow-400 text-sm sm:text-base text-right z-10">
        <p>2.0</p>
        <p id="welcome-message">Welcome, ?</p>
        <a href="#" id="auth-link" class="text-xs" style="color: #969696;">(sign up / sign in)</a>
    </div>

    <audio id="audio-player"></audio>
    <div id="music-player-widget" class="pixel-font">
        <img id="player-cover-art" src="httpsa://placehold.co/64x64/000000/333333?text=...&font=vt323" alt="Album Cover">
        <div id="player-main">
            <div id="player-info-container" title="...">
                <div id="player-title">...</div>
                <div id="player-artist">Loading...</div>
            </div>
            <div class="player-controls-row">
                <button id="rewind-btn" title="Previous">[<<]</button>
                <button id="play-pause-btn" title="Play/Pause">[>]</button>
                <button id="skip-btn" title="Next (Shuffle)">[>>]</button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" title="Volume">
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const playerTitleEl = document.getElementById('player-title');
            const playerArtistEl = document.getElementById('player-artist');
            
            try {
                // --- NEW 1/100 BACKGROUND LOGIC ---
                const specialBg = '81853ABB-FB87-4A20-9303-9624B777245B.jpeg';
                const normalBackgrounds = [
                    'IMG_4928.jpeg',
                    'IMG_4946.jpeg',
                    'IMG_4944.jpeg',
                    'IMG_4943.jpeg',
                    'IMG_4945.jpeg'
                    // Add your other normal images here
                ];

                // Generate a random number between 0 and 99
                const chance = Math.floor(Math.random() * 100); 
                let chosenBg;

                if (chance === 0) { // This gives a 1 in 100 chance (for the number 0)
                    chosenBg = specialBg;
                } else {
                    // This is the 99 in 100 case: pick from the normal list
                    chosenBg = normalBackgrounds[Math.floor(Math.random() * normalBackgrounds.length)];
                }
                
                // Apply the chosen image to the body
                document.body.style.backgroundImage = `url('${chosenBg}')`;
                
                
                // --- Splash Text & Auth Logic ---
                const splashElement = document.getElementById('splash-text');
                if (splashElement) {
                    const splashOptions = [
                        "are you a freshman?", "2 sweet teas and...", "bbq chicken alert", 
                        "trick or treat, smell my.. donuts..", "pull up to ur block with intelligence",
                        "john deere approved!", "long live futtbucker67", "six seven", "oh brother..",
                        "are you even an ew student?", "i added the proxy and ai", "get the bawlls!!",
                        "six one", "add jiggletip on clash, i only got 2100 though, am willing to put up a good game",
                        "sorry but you are not a sigma", "idk really what to say"
                    ];
                    splashElement.textContent = splashOptions[Math.floor(Math.random() * splashOptions.length)];
                }
                
                const welcomeMessage = document.getElementById('welcome-message');
                const authLink = document.getElementById('auth-link');
                function updateUI() {
                    let username = localStorage.getItem('username');
                    if (username) {
                        welcomeMessage.textContent = `Welcome, ${username}`;
                        authLink.textContent = '(sign out)';
                        authLink.onclick = signOut;
                    } else {
                        welcomeMessage.textContent = 'Welcome, ?';
                        authLink.textContent = '(sign up / sign in)';
                        authLink.onclick = signIn;
                    }
                }
                function signIn(e) {
                    e.preventDefault();
                    const name = prompt('Enter yourname:');
                    if (name && name.trim() !== '') {
                        localStorage.setItem('username', name.trim());
                        updateUI();
                    }
                }
                function signOut(e) {
                    e.preventDefault();
                    localStorage.removeItem('username');
                    updateUI();
                }
                updateUI();
                
                
                // --- NEW PERSISTENT MUSIC PLAYER LOGIC ---
                const audioPlayer = document.getElementById('audio-player');
                const playPauseBtn = document.getElementById('play-pause-btn');
                const rewindBtn = document.getElementById('rewind-btn');
                const skipBtn = document.getElementById('skip-btn');
                const playerInfoContainer = document.getElementById('player-info-container');
                const volumeSlider = document.getElementById('volume-slider');
                const playerCoverArt = document.getElementById('player-cover-art');
                const placeholderCover = "https://placehold.co/64x64/000000/333333?text=...&font=vt323";
                
                let currentSongIndex = 0;
                let isPlaying = false;
                
                if (typeof playlist === 'undefined') {
                    playerTitleEl.textContent = "Error";
                    playerArtistEl.textContent = "playlist.js missing";
                    return; 
                }

                const secretSong = {
                    title: "hey, big guy said im an easter egg",
                    artist: "i heard, if u put /secret at the end of the link",
                    src: "clock.mp3",
                    cover: "handofpeace.jpg"
                };

                function loadSong(songIndex) {
                    const song = (songIndex === -1) ? secretSong : playlist[songIndex];
                    if (!song || !song.src || !song.cover) {
                        console.error("Invalid song data at index:", songIndex);
                        skipSong(true); // Skip invalid/placeholder
                        return;
                    }
                    
                    audioPlayer.src = song.src; 
                    playerInfoContainer.title = `${song.title} - ${song.artist}`; 
                    playerTitleEl.textContent = song.title;
                    playerArtistEl.textContent = song.artist;
                    playerCoverArt.src = song.cover;
                    playPauseBtn.textContent = '[>]';
                    isPlaying = false;
                }

                function playSong() {
                    if (!audioPlayer.src) { return; }
                    audioPlayer.volume = volumeSlider.value; 
                    
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            playPauseBtn.textContent = '[||]';
                            isPlaying = true;
                        }).catch(error => {
                            // This usually happens if the user hasn't clicked the page yet
                            console.warn("Auto-play failed:", error.name);
                            playerTitleEl.textContent = "Click Play";
                            playerArtistEl.textContent = "to start music";
                            isPlaying = false;
                        });
                    }
                }

                function pauseSong() {
                    audioPlayer.pause();
                    playPauseBtn.textContent = '[>]';
                    isPlaying = false;
                }

                function togglePlayPause() {
                    if (isPlaying) {
                        pauseSong();
                    } else {
                        playSong();
                    }
                }

                function skipSong(skipOnly = false) {
                    let nextSongIndex = Math.floor(Math.random() * playlist.length);
                    if (nextSongIndex === currentSongIndex && playlist.length > 1) {
                        nextSongIndex = (nextSongIndex + 1) % playlist.length; 
                    }
                    currentSongIndex = nextSongIndex;
                    loadSong(currentSongIndex);
                    
                    if (audioPlayer.src && !skipOnly) {
                       playSong();
                    }
                }

                function rewindSong() {
                    currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
                    loadSong(currentSongIndex);
                    if (audioPlayer.src) {
                        playSong();
                    }
                }
                
                // --- 1. SAVE STATE WHEN LEAVING ---
                window.addEventListener('beforeunload', () => {
                    if (audioPlayer.currentTime > 0) {
                        const musicState = {
                            currentSongIndex: currentSongIndex,
                            currentTime: audioPlayer.currentTime,
                            volume: audioPlayer.volume,
                            isPlaying: isPlaying
                        };
                        sessionStorage.setItem('musicPlayerState', JSON.stringify(musicState));
                    } else {
                        sessionStorage.removeItem('musicPlayerState');
                    }
                });
                
                // --- 2. LOAD STATE ON NEW PAGE ---
                function loadInitialState() {
                    const savedStateJSON = sessionStorage.getItem('musicPlayerState');
                    let savedState = null;
                    
                    if (savedStateJSON) {
                        try {
                            savedState = JSON.parse(savedStateJSON);
                        } catch (e) {
                            console.error("Error parsing saved music state:", e);
                            sessionStorage.removeItem('musicPlayerState'); // Clear bad data
                        }
                    }

                    if (savedState) {
                        // We have a saved state!
                        currentSongIndex = savedState.currentSongIndex;
                        loadSong(currentSongIndex);
                        volumeSlider.value = savedState.volume || 1;
                        audioPlayer.volume = savedState.volume || 1;
                        
                        audioPlayer.addEventListener('loadedmetadata', () => {
                            audioPlayer.currentTime = savedState.currentTime || 0;
                            if (savedState.isPlaying) {
                                playSong(); // Try to resume playing
                            }
                        }, { once: true }); 
                        
                    } else {
                        // No saved state, load a random song (or secret)
                        const rareSongChance = Math.floor(Math.random() * 50);
                        currentSongIndex = (rareSongChance === 0) ? -1 : Math.floor(Math.random() * playlist.length);
                        loadSong(currentSongIndex);
                        audioPlayer.volume = volumeSlider.value;
                    }
                }
                
                // --- ATTACH LISTENERS ---
                playPauseBtn.addEventListener('click', togglePlayPause);
                skipBtn.addEventListener('click', () => skipSong(false));
                rewindBtn.addEventListener('click', rewindSong);
                
                volumeSlider.addEventListener('input', (e) => {
                    audioPlayer.volume = e.target.value;
                });

                audioPlayer.addEventListener('ended', () => skipSong(false));
                
                audioPlayer.addEventListener('error', (e) => {
                    playerTitleEl.textContent = `Load Error (404)`;
                    playerArtistEl.textContent = `Check file name`;
                    console.error("Audio player error:", e);
                });
                
                playerCoverArt.addEventListener('error', () => {
                    playerCoverArt.src = placeholderCover;
                    playerArtistEl.textContent = `${playerArtistEl.textContent} (no art)`;
                });

                // --- KICK IT OFF ---
                loadInitialState();
                
            } catch (e) {
                // Catch any other code-breaking typo
                console.error("Global script error:", e);
                playerTitleEl.textContent = "Code Error";
                playerArtistEl.textContent = e.message;
            }
        });
    </script>
</body>
</html>
