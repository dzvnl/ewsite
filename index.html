<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        html, body { height: 100%; scroll-behavior: smooth; overflow: hidden; }
        body {
            font-family: 'VT323', monospace;
            color: #e5e5e5;
            background-color: #000000; 
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center;
        }
        .pixel-font {
            font-family: 'VT323', monospace;
            font-smooth: never;
            -webkit-font-smoothing: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        
        /* --- PLAYER CSS --- */
        #music-player-widget {
            position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 50;
            width: 320px; height: auto; background-color: rgba(0, 0, 0, 0.8);
            border: none; padding: 0.75rem; display: flex; align-items: center;
        }
        #player-cover-art {
            width: 64px; height: 64px; flex-shrink: 0; margin-right: 0.75rem; 
            border: 2px dotted #969696; background-color: #111; image-rendering: pixelated;
        }
        #player-main { flex-grow: 1; overflow: hidden; min-width: 0; }
        #player-title { color: #ffffff; font-size: 1.125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-artist { font-size: 0.875rem; color: #969696; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .player-controls-row { display: flex; align-items: center; gap: 0.25rem; }
        .player-controls-row button { color: #facc15; font-size: 1.25rem; flex-shrink: 0; padding: 0 0.25rem; cursor: pointer; background: none; border: none;}
        #volume-slider { -webkit-appearance: none; width: 100%; flex-grow: 1; height: 16px; background: transparent; margin-left: 0.5rem; }
        #volume-slider::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border: 1px solid #969696; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #facc15; border: 1px solid #000; border-radius: 50%; margin-top: -7px; }

        /* --- CHAT WIDGET CSS --- */
        #chat-widget {
            position: fixed; top: 100px; left: 100px; width: 350px; height: 400px;
            background: rgba(0, 0, 0, 0.95); border: 2px solid #333;
            display: flex; flex-direction: column; z-index: 9999; resize: both; overflow: hidden;
        }
        #chat-widget.minimized { height: 36px !important; resize: none; }
        #chat-widget.closed { display: none; }
        #chat-header { background: #222; padding: 8px; cursor: move; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        #chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; font-size: 1rem; }
        #chat-input-area { background: #111; padding: 8px; border-top: 1px solid #444; }
        #chat-input { width: 100%; background: #000; color: #facc15; border: 1px solid #333; padding: 4px; outline: none; }
        .msg-row { margin-bottom: 8px; font-family: 'VT323'; }
        .msg-user { font-weight: bold; color: #888; }
        .msg-user.admin { color: #ff4444; }
        .msg-text { color: #eee; margin-left: 5px; }
        .action-link { cursor: pointer; color: #666; font-size: 0.7rem; text-decoration: underline; margin-left: 10px; }
        #staff-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 2px solid #ff4444; padding: 20px; z-index: 10000; display: none; width: 300px; }
    </style>
</head>
<body>

    <nav class="fixed left-0 top-1/2 -translate-y-1/2 p-6 sm:p-8 pixel-font z-10">
        <ul class="text-2xl lg:text-3xl space-y-1" style="color: #969696;">
            <li><a href="/secrets" class="hover:text-red-900">home</a></li>
            <li><a href="/list" class="hover:text-red-900">list</a></li>
            <li><a href="#" onclick="document.getElementById('chat-widget').classList.remove('closed'); return false;" class="hover:text-red-900">chat</a></li>
            <li><a href="https://yodelling-amberly-ewsite-0c6ae866.koyeb.app/" class="hover:text-red-900 transition-colors">proxy</a></li>
        </ul>
    </nav>

    <div class="fixed top-2/3 left-1/2 -translate-x-1/2 -translate-y-1/2 pixel-font text-yellow-400 text-lg lg:text-xl text-center z-10 p-4">
        <p id="splash-text"></p>
    </div>

    <div class="fixed top-0 right-0 p-4 pixel-font text-yellow-400 text-sm sm:text-base text-right z-10">
        <p>2.0</p>
        <p id="welcome-message" style="cursor:pointer">Welcome, ?</p>
        <a href="#" id="auth-link" class="text-xs" style="color: #969696;">(sign up / sign in)</a>
    </div>

    <audio id="audio-player"></audio>
    <div id="music-player-widget" class="pixel-font">
        <img id="player-cover-art" src="https://placehold.co/64x64/000000/333333?text=...&font=vt323" alt="Album Cover">
        <div id="player-main">
            <div id="player-info-container" title="...">
                <div id="player-title">...</div>
                <div id="player-artist">Loading...</div>
            </div>
            <div class="player-controls-row">
                <button id="rewind-btn">[<<]</button>
                <button id="play-pause-btn">[>]</button>
                <button id="skip-btn">[>>]</button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
            </div>
        </div>
    </div>

    <div id="chat-widget" class="closed pixel-font">
        <div id="chat-header">
            <span style="color:#facc15">// CHAT</span>
            <div>
                <button onclick="document.getElementById('chat-widget').classList.toggle('minimized')" style="color:#666">_</button>
                <button onclick="document.getElementById('chat-widget').classList.add('closed')" style="color:#666">X</button>
            </div>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type message...">
        </div>
    </div>

    <div id="staff-panel" class="pixel-font">
        <h2 style="color:#ff4444">STAFF_CONSOLE</h2>
        <input type="text" id="announce-input" placeholder="Announcement..." style="width:100%; background:#111; color:#fff; border:1px solid #333; margin:10px 0; padding:5px;">
        <button id="send-announcement-btn" style="width:100%; background:#400; color:#fff; margin-bottom:5px; padding:5px;">POST ANNOUNCEMENT</button>
        <button id="clear-chat-btn" style="width:100%; border:1px solid #f44; color:#f44; padding:5px; background:none;">CLEAR ALL</button>
        <button onclick="document.getElementById('staff-panel').style.display='none'" style="width:100%; margin-top:10px; color:#666; background:none; border:none;">CLOSE</button>
    </div>

    <script>
        const baseURL = "https://ewsmusic1.netlify.app/"; 
        const playlist = [
            { title: "Xtal", artist: "Aphex Twin", src: baseURL + "xtal.mp3", cover: baseURL + "aphex.jpg" },
            { title: "I Don't Wanna Be Me", artist: "Type O Negative", src: baseURL + "idontwannabeme.mp3", cover: baseURL + "ton.jpg" },
            { title: "Life Is Killing Me", artist: "Type O Negative", src: baseURL + "lifeiskilling.mp3", cover: baseURL + "ton.jpg" },
            { title: "Exit Music", artist: "Radiohead", src: baseURL + "exitmusic.mp3", cover: baseURL + "radiohead.jpg" },
            { title: "head in the ceiling fan", artist: "Title Fight", src: baseURL + "titlefight.mp3", cover: baseURL + "title-fih.jpg" },
            { title: "hit the home", artist: "the hand of peace", src: baseURL + "clock.mp3", cover: baseURL + "handofpeace.jpg" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const playerTitleEl = document.getElementById('player-title');
            const playerArtistEl = document.getElementById('player-artist');
            
            // Background Fix
            const normalBackgrounds = ['IMG_4928.jpeg', 'IMG_4946.jpeg', 'IMG_4944.jpeg', 'IMG_4943.jpeg', 'IMG_5262.jpeg', 'IMG_5263.jpeg', 'IMG_5264.jpeg', 'IMG_4945.jpeg'];
            document.body.style.backgroundImage = `url('${normalBackgrounds[Math.floor(Math.random() * normalBackgrounds.length)]}')`;

            // Splash Text
            const splashElement = document.getElementById('splash-text');
            const splashOptions = ["blacked out like an lv sandal", "bbq chicken alert", "long live futtbucker", "updates soon.. -nl"];
            splashElement.textContent = splashOptions[Math.floor(Math.random() * splashOptions.length)];

            // Auth Logic
            const welcomeMessage = document.getElementById('welcome-message');
            const authLink = document.getElementById('auth-link');
            function updateUI() {
                let user = localStorage.getItem('username');
                welcomeMessage.textContent = user ? `Welcome, ${user}` : 'Welcome, ?';
                authLink.textContent = user ? '(sign out)' : '(sign up / sign in)';
            }
            authLink.onclick = (e) => {
                e.preventDefault();
                if(localStorage.getItem('username')) { localStorage.removeItem('username'); }
                else { let n = prompt('Enter name:'); if(n) localStorage.setItem('username', n.trim()); }
                updateUI();
            };
            updateUI();

            // Music Logic
            const audio = document.getElementById('audio-player');
            const playBtn = document.getElementById('play-pause-btn');
            const vol = document.getElementById('volume-slider');
            const cover = document.getElementById('player-cover-art');
            let index = Math.floor(Math.random() * playlist.length);

            function load(i) {
                const s = playlist[i];
                audio.src = s.src; playerTitleEl.textContent = s.title; playerArtistEl.textContent = s.artist; cover.src = s.cover;
            }
            playBtn.onclick = () => { audio.paused ? audio.play() : audio.pause(); playBtn.textContent = audio.paused ? '[>]' : '[||]'; };
            document.getElementById('skip-btn').onclick = () => { index = (index + 1) % playlist.length; load(index); audio.play(); };
            document.getElementById('rewind-btn').onclick = () => { index = (index - 1 + playlist.length) % playlist.length; load(index); audio.play(); };
            vol.oninput = (e) => audio.volume = e.target.value;
            load(index);
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, onChildRemoved, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlUyqTb9onQ0PyOxLfZkDddeSnYdB2PlQ",
            authDomain: "ewsitechat.firebaseapp.com",
            databaseURL: "https://ewsitechat-default-rtdb.firebaseio.com",
            projectId: "ewsitechat",
            storageBucket: "ewsitechat.firebasestorage.app",
            messagingSenderId: "282495574514",
            appId: "1:282495574514:web:e2781da630d93fc1ce8b6b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const chatRef = ref(db, 'chat_messages');
        const admins = ['-nl', 'fb67', 'root'];

        document.getElementById('chat-input').onkeydown = (e) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                const user = localStorage.getItem('username') || "Guest";
                push(chatRef, { user, text: e.target.value, type: 'msg', timestamp: serverTimestamp() });
                e.target.value = "";
            }
        };

        onChildAdded(chatRef, (snap) => {
            const data = snap.val();
            const isAdmin = admins.includes(data.user);
            const row = document.createElement('div');
            row.className = 'msg-row';
            row.id = `msg-${snap.key}`;
            let html = `<span class="msg-user ${isAdmin ? 'admin' : ''}">${data.user}:</span> <span class="msg-text">${data.text}</span>`;
            if(admins.includes(localStorage.getItem('username'))) {
                html += `<span class="action-link" style="color:red" onclick="window.delMsg('${snap.key}')">[del]</span>`;
            }
            row.innerHTML = html;
            document.getElementById('chat-messages').appendChild(row);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        });

        onChildRemoved(chatRef, (snap) => document.getElementById(`msg-${snap.key}`)?.remove());

        window.delMsg = (id) => remove(ref(db, `chat_messages/${id}`));
        document.getElementById('clear-chat-btn').onclick = () => { if(confirm("Clear chat?")) remove(chatRef); };
        document.getElementById('send-announcement-btn').onclick = () => {
            const txt = document.getElementById('announce-input').value;
            if(txt) push(chatRef, { user: localStorage.getItem('username'), text: txt, type: 'announcement' });
            document.getElementById('announce-input').value = "";
        };

        const widget = document.getElementById('chat-widget');
        const header = document.getElementById('chat-header');
        let drag = false, offset = [0,0];
        header.onmousedown = (e) => { drag = true; offset = [widget.offsetLeft - e.clientX, widget.offsetTop - e.clientY]; };
        document.onmousemove = (e) => { if(drag) { widget.style.left = (e.clientX + offset[0]) + 'px'; widget.style.top = (e.clientY + offset[1]) + 'px'; } };
        document.onmouseup = () => drag = false;

        document.getElementById('welcome-message').onclick = () => {
            if(admins.includes(localStorage.getItem('username'))) document.getElementById('staff-panel').style.display = 'block';
        };
    </script>

</body>
</html>
