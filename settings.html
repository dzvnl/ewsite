<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SETTINGS // CONFIG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'VT323', monospace;
            color: #e5e5e5;
            background-color: #000;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .settings-card {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,1);
            backdrop-filter: blur(5px);
        }

        h1 {
            color: #facc15;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            color: #969696;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        input, textarea {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            outline: none;
        }

        input:focus, textarea:focus { border-color: #facc15; }
        
        /* Make username look locked */
        input:read-only {
            background: #222;
            color: #555;
            cursor: not-allowed;
            border-color: #222;
        }

        textarea { height: 100px; resize: vertical; }

        .btn {
            width: 100%;
            padding: 10px;
            font-size: 1.4rem;
            font-family: 'VT323', monospace;
            cursor: pointer;
            border: none;
            margin-top: 10px;
            transition: 0.2s;
        }

        .save-btn { background: #facc15; color: #000; }
        .save-btn:hover { background: #fff; }

        .cancel-btn { background: transparent; border: 1px solid #444; color: #666; margin-top: 15px; }
        .cancel-btn:hover { border-color: #ef4444; color: #ef4444; }

        .preview-img {
            width: 100px;
            height: 100px;
            border: 2px solid #facc15;
            object-fit: cover;
            display: block;
            margin: 0 auto 20px auto;
            background: #000;
        }

        .divider {
            border-top: 1px solid #333;
            margin: 25px 0;
            position: relative;
        }
        .divider span {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            padding: 0 10px;
            color: #444;
        }
    </style>
</head>
<body>

    <div class="settings-card">
        <h1>/// CONFIGURATION ///</h1>

        <img id="pfp-preview" class="preview-img" src="https://placehold.co/100x100/111/facc15?text=?">

        <div class="form-group">
            <label>USERNAME (CANNOT CHANGE)</label>
            <input type="text" id="username-field" readonly>
        </div>

        <div class="form-group">
            <label>PROFILE PICTURE URL</label>
            <input type="text" id="pfp-field" placeholder="https://example.com/image.jpg" oninput="updatePreview()">
        </div>

        <div class="form-group">
            <label>BIO / STATUS</label>
            <textarea id="bio-field" placeholder="Enter your bio..."></textarea>
        </div>

        <div class="divider"><span>SECURITY</span></div>

        <div class="form-group">
            <label>NEW PASSWORD (LEAVE EMPTY TO KEEP CURRENT)</label>
            <input type="text" id="new-pass-field" placeholder="Enter new password...">
        </div>

        <div class="form-group">
            <label style="color:#ef4444;">* CONFIRM CURRENT PASSWORD TO SAVE</label>
            <input type="password" id="current-pass-field" placeholder="Required to make changes...">
        </div>

        <button class="btn save-btn" onclick="saveSettings()">[ SAVE CHANGES ]</button>
        <button class="btn cancel-btn" onclick="goBack()">CANCEL / RETURN</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAlUyqTb9onQ0PyOxLfZkDddeSnYdB2PlQ",
            authDomain: "ewsitechat.firebaseapp.com",
            databaseURL: "https://ewsitechat-default-rtdb.firebaseio.com",
            projectId: "ewsitechat",
            storageBucket: "ewsitechat.firebasestorage.app",
            messagingSenderId: "282495574514",
            appId: "1:282495574514:web:e2781da630d93fc1ce8b6b"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- INIT ---
        const myUsername = localStorage.getItem('username');
        if (!myUsername) window.location.href = 'login.html';

        document.getElementById('username-field').value = myUsername;

        // Background logic
        const bgs = ['IMG_4928.jpeg', 'IMG_4946.jpeg', 'IMG_4944.jpeg'];
        document.body.style.backgroundImage = `url('${bgs[Math.floor(Math.random()*bgs.length)]}')`;

        // Load current data
        const userRef = ref(db, 'users/' + myUsername);
        let currentRealPassword = ""; // To store the actual password for verification

        get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                if (data.bio) document.getElementById('bio-field').value = data.bio;
                if (data.pfp) {
                    document.getElementById('pfp-field').value = data.pfp;
                    document.getElementById('pfp-preview').src = data.pfp;
                }
                currentRealPassword = data.password;
            }
        });

        // --- FUNCTIONS ---
        
        window.updatePreview = () => {
            const url = document.getElementById('pfp-field').value;
            if(url) document.getElementById('pfp-preview').src = url;
        };

        window.goBack = () => {
            window.location.href = 'account.html';
        };

        window.saveSettings = async () => {
            const enteredCurrentPass = document.getElementById('current-pass-field').value;
            const newPass = document.getElementById('new-pass-field').value;
            const newBio = document.getElementById('bio-field').value;
            const newPfp = document.getElementById('pfp-field').value;

            // 1. Verify Identity
            if (enteredCurrentPass !== currentRealPassword) {
                alert("ERROR: INCORRECT CURRENT PASSWORD.\nChanges rejected.");
                return;
            }

            // 2. Prepare Updates
            const updates = {};
            updates['/bio'] = newBio;
            updates['/pfp'] = newPfp;

            // Only update password if they typed something new
            if (newPass.trim() !== "") {
                updates['/password'] = newPass;
            }

            // 3. Send to Firebase
            try {
                await update(userRef, updates);
                alert("SUCCESS: PROFILE UPDATED.");
                window.location.href = 'account.html';
            } catch (error) {
                alert("ERROR: Could not save data. " + error.message);
            }
        };
    </script>
</body>
</html>